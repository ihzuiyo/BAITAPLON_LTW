@model IEnumerable<StudentManagement.Models.Enrollment>
@{
    ViewData["Title"] = "Xem Điểm";
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";
    var classInfo = ViewBag.ClassInfo as StudentManagement.Models.Class;
    var classId = ViewBag.ClassId;
}

<div class="dashboard-header">
    <div>
        <h1 class="page-title">
            <i class="fas fa-clipboard-list"></i> Bảng Điểm Lớp Học
        </h1>
        @if (classInfo != null)
        {
            <p class="page-subtitle">
                <strong>Lớp:</strong> @classInfo.ClassName (@classInfo.ClassCode) | 
                <strong>Khóa học:</strong> @classInfo.Course?.CourseName
            </p>
        }
    </div>
    <div class="header-actions">
        <a asp-action="ScoresManagement" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Quay lại
        </a>
        <button class="btn btn-success" onclick="window.print()">
            <i class="fas fa-file-excel"></i> Xuất Excel
        </button>
        <button class="btn btn-primary" onclick="window.print()">
            <i class="fas fa-print"></i> In Bảng Điểm
        </button>
    </div>
</div>

@if (Model != null && Model.Any())
{
    <!-- Score Statistics -->
    <div class="row mb-4">
        @{
            var totalStudents = Model.Count();
            var studentsWithScores = Model.Count(e => e.Scores != null && e.Scores.Any());
            var averageScore = 0.0;
            var excellentCount = 0;
            var goodCount = 0;
            
            if (studentsWithScores > 0)
            {
                var allAverages = Model.Where(e => e.Scores != null && e.Scores.Any())
                    .Select(e => {
                        var attendance = e.Scores.FirstOrDefault(s => s.ScoreType?.ScoreTypeName == "Chuyên cần")?.ScoreValue ?? 0;
                        var midterm = e.Scores.FirstOrDefault(s => s.ScoreType?.ScoreTypeName == "Giữa kỳ")?.ScoreValue ?? 0;
                        var final = e.Scores.FirstOrDefault(s => s.ScoreType?.ScoreTypeName == "Cuối kỳ")?.ScoreValue ?? 0;
                        return (double)((attendance * 0.1m) + (midterm * 0.3m) + (final * 0.6m));
                    }).ToList();
                
                averageScore = allAverages.Average();
                excellentCount = allAverages.Count(a => a >= 8.5);
                goodCount = allAverages.Count(a => a >= 7.0 && a < 8.5);
            }
        }
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card stat-card-blue">
                <div class="card-body">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-details">
                        <div class="stat-number">@totalStudents</div>
                        <div class="stat-label">Tổng Học Viên</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card stat-card-green">
                <div class="card-body">
                    <div class="stat-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-details">
                        <div class="stat-number">@averageScore.ToString("F2")</div>
                        <div class="stat-label">Điểm Trung Bình</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card stat-card-orange">
                <div class="card-body">
                    <div class="stat-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-details">
                        <div class="stat-number">@excellentCount</div>
                        <div class="stat-label">Học Viên Giỏi</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card stat-card-teal">
                <div class="card-body">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-details">
                        <div class="stat-number">@goodCount</div>
                        <div class="stat-label">Học Viên Khá</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scores Table -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-table"></i> Bảng Điểm Chi Tiết</h5>
                <div>
                    <input type="text" class="form-control form-control-sm" id="searchStudent" placeholder="Tìm kiếm học viên..." style="width: 250px;">
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th rowspan="2" class="align-middle text-center" width="5%">STT</th>
                            <th rowspan="2" class="align-middle" width="12%">Mã SV</th>
                            <th rowspan="2" class="align-middle" width="20%">Họ và Tên</th>
                            <th colspan="3" class="text-center">Điểm Thành Phần</th>
                            <th rowspan="2" class="align-middle text-center" width="10%">Điểm TB</th>
                            <th rowspan="2" class="align-middle text-center" width="10%">Xếp Loại</th>
                        </tr>
                        <tr>
                            <th class="text-center" width="10%">Chuyên Cần<br/><small>(10%)</small></th>
                            <th class="text-center" width="10%">Giữa Kỳ<br/><small>(30%)</small></th>
                            <th class="text-center" width="13%">Cuối Kỳ<br/><small>(60%)</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var stt = 1;
                        }
                        @foreach (var enrollment in Model.OrderBy(e => e.Student?.FullName))
                        {
                            var student = enrollment.Student;
                            var scores = enrollment.Scores?.ToList() ?? new List<StudentManagement.Models.Score>();
                            
                            var attendanceScore = scores.FirstOrDefault(s => s.ScoreType?.ScoreTypeName == "Chuyên cần")?.ScoreValue ?? 0;
                            var midtermScore = scores.FirstOrDefault(s => s.ScoreType?.ScoreTypeName == "Giữa kỳ")?.ScoreValue ?? 0;
                            var finalScore = scores.FirstOrDefault(s => s.ScoreType?.ScoreTypeName == "Cuối kỳ")?.ScoreValue ?? 0;

                            var studentAverageScore = (attendanceScore * 0.1m) + (midtermScore * 0.3m) + (finalScore * 0.6m);

                            var classification = studentAverageScore >= 8.5m ? "Giỏi" :
                                               studentAverageScore >= 7.0m ? "Khá" :
                                               studentAverageScore >= 5.5m ? "Trung Bình" :
                                               studentAverageScore >= 4.0m ? "Yếu" : "Kém";
                            string classificationBadge;
                            switch (classification)
                            {
                                case "Giỏi":
                                    classificationBadge = "bg-success";
                                    break;
                                case "Khá":
                                    classificationBadge = "bg-info";
                                    break;
                                case "Trung Bình":
                                    classificationBadge = "bg-warning text-dark";
                                    break;
                                default:
                                    classificationBadge = "bg-danger";
                                    break;
                            }

                            <tr>
                                <td class="text-center"><strong>@stt</strong></td>
                                <td>
                                    <span class="badge bg-info">@student?.StudentCode</span>
                                </td>
                                <td>
                                    <strong>@student?.FullName</strong>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">@attendanceScore.ToString("F1")</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">@midtermScore.ToString("F1")</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">@finalScore.ToString("F1")</span>
                                </td>
                                <td class="text-center">
                                    <strong class="text-primary" style="font-size: 16px;">@studentAverageScore.ToString("F2")</strong>
                                </td>
                                <td class="text-center">
                                    <span class="badge @classificationBadge">@classification</span>
                                </td>
                            </tr>
                            stt++;
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <div class="card">
        <div class="card-body">
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">Chưa có dữ liệu điểm</h5>
                <p class="text-muted">Vui lòng chọn lớp học để xem điểm</p>
                <a asp-action="ScoresManagement" class="btn btn-primary mt-3">
                    <i class="fas fa-arrow-left"></i> Quay lại danh sách lớp
                </a>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Search functionality
            $('#searchStudent').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('tbody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });
        });
    </script>
}
