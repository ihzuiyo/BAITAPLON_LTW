@model IEnumerable<StudentManagement.Models.User>
@{
    ViewData["Title"] = "Quản Lý Người Dùng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="dashboard-header">
    <h1 class="page-title"><i class="fas fa-users"></i> Quản Lý Người Dùng</h1>
    <div class="header-actions">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="fas fa-user-plus"></i> Thêm Người Dùng
        </button>
        <button class="btn btn-success" onclick="exportUsersToExcel()">
            <i class="fas fa-file-excel"></i> Xuất Excel
        </button>
        @* <button class="btn btn-warning">
            <i class="fas fa-file-excel"></i> Phân quyền
        </button> *@
    </div>
</div>

<!-- User Statistics -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="user-stat-card stat-total">
            <div class="stat-icon-wrapper">
                <i class="fas fa-users-cog"></i>
            </div>
            <div class="stat-info">
                <h3>@Model.Count()</h3>
                <p>Tổng Người Dùng</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="user-stat-card stat-admin">
            <div class="stat-icon-wrapper">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="stat-info">
                <h3>@Model.Count(u => u.Role?.RoleName == "Admin")</h3>
                <p>Quản Trị Viên</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="user-stat-card stat-teacher">
            <div class="stat-icon-wrapper">
                <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <div class="stat-info">
                <h3>@Model.Count(u => u.Role?.RoleName == "Teacher")</h3>
                <p>Giảng Viên</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="user-stat-card stat-student">
            <div class="stat-icon-wrapper">
                <i class="fas fa-user-graduate"></i>
            </div>
            <div class="stat-info">
                <h3>@Model.Count(u => u.Role?.RoleName == "Student")</h3>
                <p>Sinh Viên</p>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list-ul"></i> Danh Sách Người Dùng</h5>
            <div class="header-stats">
                <span class="badge bg-success">
                    <i class="fas fa-check-circle"></i> 
                    @Model.Count(u => u.Status == "Active") Hoạt động
                </span>
                <span class="badge bg-danger ms-2">
                    <i class="fas fa-ban"></i> 
                    @Model.Count(u => u.Status == "Inactive") Không hoạt động
                </span>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-controls mb-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchUser" placeholder="Tìm kiếm theo tên, email, username...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterRole">
                        <option value="">Tất cả vai trò</option>
                        <option value="Admin">Admin</option>
                        <option value="Teacher">Giảng viên</option>
                        <option value="Student">Sinh viên</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterStatus">
                        <option value="">Tất cả trạng thái</option>
                        <option value="Active">Hoạt động</option>
                        <option value="Inactive">Không hoạt động</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="sortBy">
                        <option value="newest">Mới nhất</option>
                        <option value="oldest">Cũ nhất</option>
                        <option value="name">Tên A-Z</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="entriesPerPage">
                        <option value="10">10 dòng</option>
                        <option value="25">25 dòng</option>
                        <option value="50">50 dòng</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover data-table">
                <thead>
                    <tr>
                        <th width="3%"><input type="checkbox" id="selectAll"></th>
                        <th width="5%">ID</th>
                        <th width="15%">Họ và Tên</th>
                        <th width="12%">Username</th>
                        <th width="15%">Email</th>
                        <th width="10%">Số Điện Thoại</th>
                        <th width="10%">Vai Trò</th>
                        <th width="10%">Trạng Thái</th>
                        <th width="10%">Ngày Tạo</th>
                        <th width="10%">Thao Tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model.OrderByDescending(u => u.DateCreated))
                    {
                        var roleName = user.Role?.RoleName ?? "Chưa phân quyền";
                        var roleBadgeClass = roleName switch
                        {
                            "Admin" => "bg-danger",
                            "Teacher" => "bg-primary",
                            "Student" => "bg-info",
                            _ => "bg-secondary"
                        };
                        
                        var roleIcon = roleName switch
                        {
                            "Admin" => "fa-user-shield",
                            "Teacher" => "fa-chalkboard-teacher",
                            "Student" => "fa-user-graduate",
                            _ => "fa-user"
                        };
                        
                        var statusBadge = user.Status == "Active" ? "bg-success" : "bg-danger";
                        var statusText = user.Status == "Active" ? "Hoạt động" : "Không hoạt động";

                        <tr data-user-id="@user.UserId">
                            <td><input type="checkbox" class="row-checkbox"></td>
                            <td><strong class="text-primary">#@user.UserId</strong></td>
                            <td>
                                <div class="user-info-cell">
                                    <div class="user-avatar">
                                        <i class="fas @roleIcon"></i>
                                    </div>
                                    <div class="user-details">
                                        <strong>@(user.FullName ?? "Chưa cập nhật")</strong>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="username-badge">
                                    <i class="fas fa-at"></i> @user.Username
                                </span>
                            </td>
                            <td>
                                <small>
                                    <i class="fas fa-envelope text-muted"></i> @user.Email
                                </small>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(user.PhoneNumber))
                                {
                                    <small>
                                        <i class="fas fa-phone text-success"></i> @user.PhoneNumber
                                    </small>
                                }
                                else
                                {
                                    <small class="text-muted fst-italic">Chưa có</small>
                                }
                            </td>
                            <td>
                                <span class="badge @roleBadgeClass">
                                    <i class="fas @roleIcon"></i> @roleName
                                </span>
                            </td>
                            <td>
                                <span class="badge @statusBadge">@statusText</span>
                            </td>
                            <td>
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i>
                                    @user.DateCreated.ToString("dd/MM/yyyy")
                                </small>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    @* Nút Chi tiết: Trỏ đến AdminController.UserDetails *@
                                    <a asp-action="UserDetails" asp-route-id="@user.UserId" class="btn btn-sm btn-info" title="Chi tiết">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    @* Nút Chỉnh Sửa: Liên kết đến EditUser (GET) *@
                                    <a asp-action="EditUser" asp-route-id="@user.UserId" class="btn btn-sm btn-primary" title="Chỉnh sửa">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    @* Nút Đổi mật khẩu: Liên kết đến AdminController.ChangePassword (GET) *@
                                    <a asp-action="ChangePassword" asp-route-id="@user.UserId" class="btn btn-sm btn-warning" title="Đổi mật khẩu">
                                        <i class="fas fa-key"></i>
                                    </a>
                                    @* Form cho chức năng Kích hoạt/Vô hiệu hóa *@
                                    <form asp-action="ToggleUserStatus" asp-route-id="@user.UserId" asp-controller="Admin" method="post" onsubmit="return confirm('Bạn có chắc chắn muốn @(user.Status == "Active" ? "vô hiệu hóa" : "kích hoạt") người dùng @user.Username không?');" style="display:inline;">
                                        @Html.AntiForgeryToken()
                                        @if (user.Status == "Active")
                                        {
                                            <button type="submit" class="btn btn-sm btn-danger" title="Vô hiệu hóa">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="submit" class="btn btn-sm btn-success" title="Kích hoạt">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        }
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="pagination-container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="pagination-info">
                    Hiển thị <strong>1</strong> đến <strong>@Math.Min(10, Model.Count())</strong> trong tổng số <strong>@Model.Count()</strong> người dùng
                </div>
                <nav>
                    <ul class="pagination mb-0">
                        <li class="page-item disabled">
                            <a class="page-link" href="#"><i class="fas fa-chevron-left"></i></a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#"><i class="fas fa-chevron-right"></i></a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add New User -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addUserModalLabel">
                    <i class="fas fa-user-plus"></i> Thêm Người Dùng Mới
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                @* TRỎ FORM ĐẾN ACTION CREATEUSER *@
                <form id="addUserForm" asp-controller="Admin" asp-action="CreateUser" method="post">
                    @Html.AntiForgeryToken()

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-user"></i> Họ và Tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="FullName" placeholder="Nhập họ và tên" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-at"></i> Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="Username" placeholder="Nhập username" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-envelope"></i> Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" name="Email" placeholder="example@email.com" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-phone"></i> Số Điện Thoại</label>
                            <input type="tel" class="form-control" name="PhoneNumber" placeholder="0xxxxxxxxx">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-lock"></i> Mật Khẩu <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" name="Password" placeholder="Nhập mật khẩu" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-lock"></i> Xác Nhận Mật Khẩu <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" name="ConfirmPassword" placeholder="Nhập lại mật khẩu" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-user-tag"></i> Vai Trò <span class="text-danger">*</span></label>
                            @* Dùng ViewBag.Roles để đổ dữ liệu *@
                            <select class="form-select" name="RoleId" required>
                                <option value="">-- Chọn vai trò --</option>
                                @if (ViewBag.Roles is List<StudentManagement.Models.Role> roles)
                                {
                                    @foreach (var role in roles)
                                    {
                                        <option value="@role.RoleId">@role.RoleName</option>
                                    }
                                }
                                else
                                {
                                    @* Fallback nếu không có ViewBag.Roles *@
                                    <option value="1">Admin</option>
                                    <option value="2">Teacher</option>
                                    <option value="3">Student</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-toggle-on"></i> Trạng Thái</label>
                            <select class="form-select" name="Status">
                                <option value="Active" selected>Hoạt động</option>
                                <option value="Inactive">Không hoạt động</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Hủy
                </button>
                <button type="submit" form="addUserForm" class="btn btn-primary">
                    <i class="fas fa-save"></i> Lưu Người Dùng
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="changeRoleModal" tabindex="-1" aria-labelledby="changeRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="changeRoleModalLabel">
                    <i class="fas fa-file-excel"></i> Phân Quyền Hàng Loạt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="changeRoleForm" asp-controller="Admin" asp-action="ChangeRoles" method="post">
                @Html.AntiForgeryToken()

                <div class="modal-body">
                    <p>Bạn đang thay đổi vai trò cho <strong id="selectedUserCount">0</strong> người dùng được chọn.</p>

                    <input type="hidden" name="UserIds" id="selectedUserIds" />

                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-user-tag"></i> Chọn Vai Trò Mới <span class="text-danger">*</span></label>
                        @* Dùng ViewBag.Roles để đổ dữ liệu *@
                        <select class="form-select" name="NewRoleId" required>
                            <option value="">-- Chọn vai trò mới --</option>
                            @if (ViewBag.Roles is List<StudentManagement.Models.Role> roles)
                            {
                                @foreach (var role in roles)
                                {
                                    <option value="@role.RoleId">@role.RoleName</option>
                                }
                            }
                            else
                            {
                                @* Fallback nếu không có ViewBag.Roles *@
                                <option value="1">Admin</option>
                                <option value="2">Teacher</option>
                                <option value="3">Student</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-sync-alt"></i> Cập Nhật Vai Trò
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .user-stat-card {
            border-radius: 10px;
            padding: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .user-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .stat-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .stat-admin {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stat-teacher {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .stat-student {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .stat-icon-wrapper {
            font-size: 45px;
            opacity: 0.8;
        }
        
        .stat-info h3 {
            margin: 0;
            font-size: 32px;
            font-weight: 700;
        }
        
        .stat-info p {
            margin: 0;
            font-size: 13px;
            opacity: 0.9;
        }
        
        .user-info-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 16px;
        }
        
        .username-badge {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.9em;
            color: #333;
        }
        
        .header-stats .badge {
            font-size: 0.85em;
            padding: 6px 12px;
        }
    </style>
    
    <script>

        function parseDate(dateString) {
            if (!dateString) return new Date(0);
            var parts = dateString.split('/');
            // Trả về YYYY, MM-1, DD
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        function exportUsersToExcel() {
            const wb = XLSX.utils.book_new();
            const wsData = [];
            
            // Headers
            wsData.push(['DANH SÁCH TÀI KHOẢN NGƯỜI DÙNG']);
            wsData.push([]);
            wsData.push(['STT', 'ID', 'Họ và Tên', 'Username', 'Email', 'Số Điện Thoại', 'Vai Trò', 'Trạng Thái', 'Ngày Tạo']);
            
            let stt = 1;
            
            // Lấy dữ liệu từ các hàng đang hiển thị trong <tbody>
                $('tbody tr:visible').each(function() {
            const $row = $(this);

            // --- SỬA LỖI TRÍCH XUẤT DỮ LIỆU ---
            const userId = $row.find('td:nth-child(2) strong').text().trim().replace('#', '');
            const fullName = $row.find('td:nth-child(3) strong').text().trim();

            // SỬA: Lấy username bằng cách loại bỏ icon/khoảng trắng
            const usernameFullText = $row.find('td:nth-child(4)').text().trim();
            const username = usernameFullText.replace(/fas fa-at\s*/i, '').trim();

            const email = $row.find('td:nth-child(5) small').text().trim();

            // SỬA: Loại bỏ icon và khoảng trắng khỏi số điện thoại
            const phoneNumber = $row.find('td:nth-child(6) small').text().trim().replace(/fas fa-phone\s*/i, '').trim() || 'N/A';

            const role = $row.find('td:nth-child(7) .badge').text().trim();
            const status = $row.find('td:nth-child(8) .badge').text().trim();
            const dateCreated = $row.find('td:nth-child(9) small').text().trim().replace('fas fa-calendar', '').trim();

            wsData.push([stt++, userId, fullName, username, email, phoneNumber, role, status, dateCreated]);
        });
            
            // Ghi file
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'DanhSachNguoiDung');
            XLSX.writeFile(wb, 'DanhSachNguoiDung.xlsx');
        }



        $(document).ready(function() {
            

        // Lấy tất cả các hàng dữ liệu ban đầu
            var $rows = $('tbody tr');

            // ===============================================
            // 1. HÀM LỌC VÀ SẮP XẾP TỔNG HỢP
            // ===============================================
            function applyFiltersAndSorting() {
                var searchTerm = $('#searchUser').val().toLowerCase();
                var filterRole = $('#filterRole').val().toLowerCase();
                var filterStatus = $('#filterStatus').val().toLowerCase();
                var sortBy = $('#sortBy').val();

                // 1.1 Lọc (Filter)
                $rows.each(function() {
                    var $row = $(this);
                    var isMatch = true;

                    // Lấy giá trị từ các cột cụ thể trong hàng
                    var fullName = $row.find('td:nth-child(3) strong').text().toLowerCase();
                    var username = $row.find('td:nth-child(4) .username-badge').text().toLowerCase();
                    var email = $row.find('td:nth-child(5) small').text().toLowerCase();
                    var role = $row.find('td:nth-child(7) .badge').text().toLowerCase().trim();
                    var statusTextInRow = $row.find('td:nth-child(8) .badge').text().toLowerCase().trim(); // Lấy giá trị: "hoạt động" hoặc "không hoạt động"

                    // --- 1. Lọc theo Tìm kiếm chung (Tên, Username, Email) ---
                    var searchContent = fullName + username + email;
                    if (searchTerm && searchContent.indexOf(searchTerm) === -1) {
                        isMatch = false;
                    }

                    // --- 2. Lọc theo Vai trò (Role) ---
                    if (isMatch && filterRole && role.indexOf(filterRole) === -1) {
                        isMatch = false;
                    }

                    // --- 3. Lọc theo Trạng thái (Status) ---

                    if (isMatch && filterStatus) {
                        // Ánh xạ giá trị hiển thị (tiếng Việt) sang giá trị logic (tiếng Anh)
                        var statusLogicValue = '';
                        if (statusTextInRow === 'hoạt động') {
                            statusLogicValue = 'active';
                        } else if (statusTextInRow === 'không hoạt động') {
                            statusLogicValue = 'inactive';
                        }

                        // So sánh giá trị logic đã ánh xạ với giá trị filter (filterStatus)
                        if (statusLogicValue.indexOf(filterStatus) === -1) {
                            isMatch = false;
                        }
                    }

                    $row.toggle(isMatch);
                

                    
                });

                // 1.2 Sắp xếp (Sorting)
                var $visibleRows = $('tbody tr:visible').get();

                $visibleRows.sort(function(a, b) {
                    var valA, valB;
                    var $elemA = $(a);
                    var $elemB = $(b);

                    switch (sortBy) {
                        case 'name': // Tên A-Z
                            valA = $elemA.find('td:nth-child(3) strong').text().toUpperCase();
                            valB = $elemB.find('td:nth-child(3) strong').text().toUpperCase();
                            return (valA < valB) ? -1 : (valA > valB) ? 1 : 0;

                        case 'newest': // Ngày tạo Mới nhất (Giảm dần)
                        case 'oldest': // Ngày tạo Cũ nhất (Tăng dần)
                            // Lấy text ngày tạo (cột 10) và chuyển đổi thành đối tượng Date
                            var dateTextA = $elemA.find('td:nth-child(10) small').text().trim().replace('i.fa-calendar', '').trim();
                            var dateTextB = $elemB.find('td:nth-child(10) small').text().trim().replace('i.fa-calendar', '').trim();

                            // Chuyển đổi định dạng DD/MM/YYYY sang Date object (cần kiểm tra thư viện nếu dùng moment.js)
                            // Sử dụng hàm parseDate để đảm bảo hoạt động trên các trình duyệt khác nhau
                            valA = parseDate(dateTextA);
                            valB = parseDate(dateTextB);

                            var comparison = valA.getTime() - valB.getTime();
                            return sortBy === 'newest' ? -comparison : comparison; // newest là giảm dần

                        default:
                            return 0;
                    }
                });

                // Chèn các hàng đã sắp xếp trở lại bảng
                $.each($visibleRows, function(index, row) {
                    $('tbody').append(row);
                });
            }

            // Hàm chuyển đổi DD/MM/YYYY thành Date Object (Cần thiết cho sorting)
            function parseDate(dateString) {
                if (!dateString) return new Date(0);
                var parts = dateString.split('/');
                // Trả về YYYY, MM-1, DD
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }


            // ===============================================
            // 2. GẮN SỰ KIỆN VÀ KHỞI TẠO
            // ===============================================

            $('#searchUser').on('keyup', applyFiltersAndSorting);
            $('#filterRole').on('change', applyFiltersAndSorting);
            $('#filterStatus').on('change', applyFiltersAndSorting);
            $('#sortBy').on('change', applyFiltersAndSorting);






            

            // Chạy hàm khi tải trang để áp dụng sắp xếp và lọc mặc định (newest)
            applyFiltersAndSorting();



            // Search functionality
            $('#searchUser').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('tbody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });

            // Select all checkboxes
            $('#selectAll').click(function() {
                $('.row-checkbox').prop('checked', this.checked);
            });
        });




         $('.header-actions button.btn-warning').on('click', function() {
            var selectedIds = [];

            // Lặp qua các checkbox được chọn trong các hàng đang hiển thị
            $('tbody tr:visible .row-checkbox:checked').each(function() {
                // Lấy ID người dùng từ thuộc tính data-user-id của thẻ <tr>
                var userId = $(this).closest('tr').data('user-id');
                if (userId) {
                    selectedIds.push(userId);
                }
            });

            if (selectedIds.length === 0) {
                alert('Vui lòng chọn ít nhất một người dùng để phân quyền.');
                return;
            }

            // Đưa danh sách ID vào trường ẩn trong Modal
            $('#selectedUserIds').val(selectedIds.join(','));
            // Cập nhật số lượng người dùng được chọn
            $('#selectedUserCount').text(selectedIds.length);

            // Hiển thị Modal
            $('#changeRoleModal').modal('show');
        });

        // Logic chọn tất cả (cần đặt lại vì bạn có hai đoạn JS ready)
        $('#selectAll').on('click', function() {
            $('.row-checkbox').prop('checked', this.checked);
        });

        // Bổ sung: Logic để chỉ chọn checkbox trên các hàng đang hiển thị
        $('#filterRole, #filterStatus, #searchUser, #entriesPerPage, #sortBy').on('change keyup', function() {
            // Gọi lại hàm lọc
            applyFiltersAndSorting();
            // Sau khi lọc, bỏ chọn tất cả checkbox để tránh nhầm lẫn
            $('#selectAll').prop('checked', false);
            $('.row-checkbox').prop('checked', false);
        });
    </script>
}
